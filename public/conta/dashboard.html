<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games | Dashboard</title>
    <link rel="icon" href="../assets/icon/icon.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../css/style.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="conta">
        <div class="navbar_conta">
            <div class="navbar_secao" id="secao_msg">
                <img src="../assets/icon/user_icon.webp" alt="icone-usuario">
                <p>Seja bem-vindo(a), <span id="nome_personalizado">usuário</span>!</p>
                <span id="welcome_msg">Esse é seu espaço personalizado para visualizar tendências e estatísticas sobre o mundo gamer. E,
                    obviamente, se divertir um pouco!</span>
            </div>
            <div class="navbar_secao" id="secao_botao">
                <div class="img_bt">
                    <img src="../assets/icon/dash_icon.png">
                    <button>Dashboard</button>
                </div>
                <div class="img_bt">
                    <img src="../assets/icon/quiz_icon.png">
                    <button onclick="exibirQuiz()">Quiz</button>
                </div>
                <div class="img_bt">
                    <img src="../assets/icon/settings_icon.png">
                    <button>Conta</button>
                </div>
            </div>
            <div class="navbar_secao" id="secao_sair">
                <img src="../assets/icon/exit_icon.png" alt="icone-saída">
                <a href="../login.html">Sair</a>
            </div>
        </div>

        <div class="conteudo">
            <div id="dash">
                <h1>Overview</h1>
                <div id="secao_kpis">
                    <div class="kpi">
                        <p>Plataforma mais utilizada</p>
                        <span class="rotulo_kpi" id="kpi_plataforma"></span>
                    </div>
                    <div class="kpi">
                        <p>Tipo de jogo favorito</p>
                        <span class="rotulo_kpi" id="kpi_tipoJogo"></span>
                    </div>
                    <div class="kpi">
                        <p>Idade média dos jogadores</p>
                        <span class="rotulo_kpi" id="kpi_idade"></span>
                    </div>
                    <div class="kpi">
                        <p>Gênero predominante</p>
                        <span class="rotulo_kpi" id="kpi_genero"></span>
                    </div>
                </div>
                <div id="secao_graficos">
                    <div id="primeira_secao">
                        <div id="barra_plataforma">
                            <p>Distribuição de Usuários por Plataforma Preferida</p>
                            <canvas id="graph_plataforma"></canvas>
                        </div>
                        <div id="barra_idade">
                            <p>Distribuição de Usuários por Faixa Etária</p>
                            <canvas id="graph_idade"></canvas>
                        </div>
                    </div>
                    <div id="segunda_secao">
                        <div id="barra_tipoJogo">
                            <p>Distribuição de Usuários por Tipo de Jogo Favorito</p>
                            <canvas id="graph_tipoJogo"></canvas>
                        </div>
                        <div id="pizza_genero">
                            <p>Distribuição de Usuários por Gênero</p>
                            <div id="pie">
                                <canvas id="graph_genero"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    nome_personalizado.innerHTML = sessionStorage.NOME_USUARIO;

    window.onload = obterDadosPlataforma();
    window.onload = obterDadosTipoJogo();
    window.onload = obterDadosGenero();
    window.onload = obterDadosIdade();
    window.onload = obterPlataformaPreferida();
    window.onload = obterTipoJogoFavorito();
    window.onload = obterIdadeMedia();
    window.onload = obterGeneroPredominante();

    // ---------- GRÁFICOS ----------

    // CRIANDO O GRÁFICO DE DISTRIBUIÇÃO POR PLATAFORMA
    function obterDadosPlataforma() {

        // Buscando dados do gráfico de Plataformas
        fetch(`/graficos/dadosPlataforma`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarPlataforma(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarPlataforma(resposta) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let rotulosPlataforma = [];
        let valoresPlataforma = [];

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            rotulosPlataforma.push(registro.Plataforma);
            valoresPlataforma.push(registro.QuantidadeTotal);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(rotulosPlataforma)
        console.log('Dados:')
        console.log(valoresPlataforma)
        console.log('----------------------------------------------')

        const graficoPlataforma = document.getElementById('graph_plataforma');

        new Chart(graficoPlataforma, {
            type: 'bar',
            data: {
                labels: rotulosPlataforma,
                datasets: [{
                    label: 'Quantidade de Usuários',
                    data: valoresPlataforma,
                    backgroundColor: '#D349C7'
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        })
    }

    // CRIANDO O GRÁFICO DE DISTRIBUIÇÃO POR TIPO DE JOGO
    function obterDadosTipoJogo() {

        fetch(`/graficos/dadosTipoJogo`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarTipoJogo(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarTipoJogo(resposta) {

        console.log('iniciando plotagem do gráfico...');

        let rotulosTipoJogo = [];
        let valoresTipoJogo = [];

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            rotulosTipoJogo.push(registro.TipoJogo);
            valoresTipoJogo.push(registro.QuantidadeTotal);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(rotulosTipoJogo)
        console.log('Dados:')
        console.log(valoresTipoJogo)
        console.log('----------------------------------------------')

        const graficoTipoJogo = document.getElementById('graph_tipoJogo');

        new Chart(graficoTipoJogo, {
            type: 'bar',
            data: {
                labels: rotulosTipoJogo,
                datasets: [{
                    label: 'Quantidade de Usuários',
                    data: valoresTipoJogo,
                    backgroundColor: '#4D0D57'
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        })
    }

    // CRIANDO O GRÁFICO DE DISTRIBUIÇÃO POR GÊNERO
    function obterDadosGenero() {

        fetch(`/graficos/dadosGenero`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarGenero(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGenero(resposta) {

        console.log('iniciando plotagem do gráfico...');

        let rotulosGenero = [];
        let valoresGenero = [];

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            rotulosGenero.push(registro.genero);
            valoresGenero.push(registro.QuantidadeTotal);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(rotulosGenero)
        console.log('Dados:')
        console.log(valoresGenero)
        console.log('----------------------------------------------')

        const graficoGenero = document.getElementById('graph_genero');

        new Chart(graficoGenero, {
            type: 'pie',
            data: {
                labels: rotulosGenero,
                datasets: [{
                    label: 'Quantidade de Usuários',
                    data: valoresGenero,
                    backgroundColor: ['#4D0D57', '#D349C7', '#F0A6EB']
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        })
    }

    // CRIANDO O GRÁFICO DE DISTRIBUIÇÃO POR FAIXA ETÁRIA
    function obterDadosIdade() {

        fetch(`/graficos/dadosIdade`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarIdade(resposta);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarIdade(resposta) {

        console.log('iniciando plotagem do gráfico...');

        let rotulosIdade = [];
        let valoresIdade = [];

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];

            rotulosIdade.push(registro.FaixaEtaria);
            valoresIdade.push(registro.QuantidadeTotal);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(rotulosIdade)
        console.log('Dados:')
        console.log(valoresIdade)
        console.log('----------------------------------------------')

        const graficoIdade = document.getElementById('graph_idade');

        new Chart(graficoIdade, {
            type: 'bar',
            data: {
                labels: rotulosIdade,
                datasets: [{
                    label: 'Quantidade de Usuários',
                    data: valoresIdade,
                    backgroundColor: '#4D0D57'
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        })
    }

    // ---------- KPIS ----------

    function obterPlataformaPreferida() {

        fetch("/graficos/plataformaPreferida", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    kpi_plataforma.innerHTML = `${resposta[0].nome}`;
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function obterTipoJogoFavorito() {

        fetch("/graficos/tipoJogoFavorito", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    kpi_tipoJogo.innerHTML = `${resposta[0].nome}`;
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function obterIdadeMedia() {

        fetch("/graficos/idadeMedia", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    kpi_idade.innerHTML = `${resposta[0].idadeMedia} anos`;
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function obterGeneroPredominante() {

        fetch("/graficos/generoPredominante", { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    kpi_genero.innerHTML = `${resposta[0].genero}`;
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    // ---------- BOTÕES ----------    
    function exibirQuiz() {
        window.location = "quiz.html";
    }
</script>